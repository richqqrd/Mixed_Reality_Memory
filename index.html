<!DOCTYPE html>
<html>

<!-- TODO curso lade zeit-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://rawgit.com/rdub80/aframe-gui/master/dist/aframe-gui.min.js"></script>
    <script src="dist/aframe-keyboard.min.js"></script>


    <script src="game-handler.js"></script>
    <script src="menu-handler.js"></script>
</head>

<body>
    <div id="overlay"></div>
    <a-scene webxr="requiredFeatures: hit-test; 
    optionalFeatures: dom-overlay, local-floor, hand-tracking;
    overlayElement: #overlay;" vr-mode-ui="enabled: true" ar-mode-ui="enabled: true"
        device-orientation-permission-ui="enabled: true" renderer="colorManagement: true"
        keyboard-shortcuts="enterVR: false">
        <a-assets>

            <a-asset-item id="left-hand-lowpoly" src="res/leftHandLow.glb"></a-asset-item>
            <a-asset-item id="right-hand-lowpoly" src="res/rightHandLow.glb"></a-asset-item>


            <!-- Poker table model -->
            <a-asset-item id="poker-table" src="res/sm_pokertable.glb"></a-asset-item>

            <!-- Card textures -->
            <img id="card-back" src="res/model/Back.png">
            <!-- Clubs -->
            <img id="club2" src="res/model/Clubs_2.png">
            <img id="club3" src="res/model/Clubs_3.png">
            <img id="club4" src="res/model/Clubs_4.png">
            <img id="club5" src="res/model/Clubs_5.png">
            <img id="club6" src="res/model/Clubs_6.png">
            <img id="club7" src="res/model/Clubs_7.png">
            <img id="club8" src="res/model/Clubs_8.png">
            <img id="club9" src="res/model/Clubs_9.png">
            <img id="club10" src="res/model/Clubs_10.png">
            <img id="clubJ" src="res/model/Clubs_J.png">
            <img id="clubQ" src="res/model/Clubs_Q.png">
            <img id="clubK" src="res/model/Clubs_K.png">
            <img id="clubA" src="res/model/Clubs_A.png">
            <!-- Hearts -->
            <img id="heart2" src="res/model/Hearts_2.png">
            <img id="heart3" src="res/model/Hearts_3.png">
            <img id="heart4" src="res/model/Hearts_4.png">
            <img id="heart5" src="res/model/Hearts_5.png">
            <img id="heart6" src="res/model/Hearts_6.png">
            <img id="heart7" src="res/model/Hearts_7.png">
            <img id="heart8" src="res/model/Hearts_8.png">
            <img id="heart9" src="res/model/Hearts_9.png">
            <img id="heart10" src="res/model/Hearts_10.png">
            <img id="heartJ" src="res/model/Hearts_J.png">
            <img id="heartQ" src="res/model/Hearts_Q.png">
            <img id="heartK" src="res/model/Hearts_K.png">
            <img id="heartA" src="res/model/Hearts_A.png">
            <!-- Diamonds -->
            <img id="diamond2" src="res/model/Diamonds_2.png">
            <img id="diamond3" src="res/model/Diamonds_3.png">
            <img id="diamond4" src="res/model/Diamonds_4.png">
            <img id="diamond5" src="res/model/Diamonds_5.png">
            <img id="diamond6" src="res/model/Diamonds_6.png">
            <img id="diamond7" src="res/model/Diamonds_7.png">
            <img id="diamond8" src="res/model/Diamonds_8.png">
            <img id="diamond9" src="res/model/Diamonds_9.png">
            <img id="diamond10" src="res/model/Diamonds_10.png">
            <img id="diamondJ" src="res/model/Diamonds_J.png">
            <img id="diamondQ" src="res/model/Diamonds_Q.png">
            <img id="diamondK" src="res/model/Diamonds_K.png">
            <img id="diamondA" src="res/model/Diamonds_A.png">

            <!-- Spades -->
            <img id="spade2" src="res/model/Spades_2.png">
            <img id="spade3" src="res/model/Spades_3.png">
            <img id="spade4" src="res/model/Spades_4.png">
            <img id="spade5" src="res/model/Spades_5.png">
            <img id="spade6" src="res/model/Spades_6.png">
            <img id="spade7" src="res/model/Spades_7.png">
            <img id="spade8" src="res/model/Spades_8.png">
            <img id="spade9" src="res/model/Spades_9.png">
            <img id="spade10" src="res/model/Spades_10.png">
            <img id="spadeJ" src="res/model/Spades_J.png">
            <img id="spadeQ" src="res/model/Spades_Q.png">
            <img id="spadeK" src="res/model/Spades_K.png">
            <img id="spadeA" src="res/model/Spades_A.png">

            <!-- Add the rosewood parquet texture -->
            <img id="floor-texture" src="res/Rosewood_Parquet.jpg">

            <!-- Wände -->
            <img id="wall-texture" src="res/wall.jpg">
        </a-assets>

        <!-- Camera -->
        <!--<a-camera position="0 3 -4"> -->
        <a-entity id="cameraRig" position="0 0 -10" rotation="0 180 0">
            <a-camera look-controls wasd-controls position="0 0 0">
                <a-gui-cursor id="cursor" raycaster="objects: [gui-interactable], .card, .collidadle" fuse="true"
                    fuse-timeout="1500" color="#ECEFF1" hover-color="#CFD8DC" active-color="#607D8B" design="ring"
                    visible="true">
                </a-gui-cursor>
                <a-entity cursor="rayOrigin: mouse" raycaster="objects: .card; far: 10;" visible="false">
                </a-entity>
            </a-camera>
        </a-entity>




        <a-plane class="room-element ar-exclude" position="0 7.5 10" rotation="0 180 0" width="20" height="15"
            material="src: #wall-texture; repeat: 8 6; side: double">
        </a-plane>

        <a-plane class="room-element ar-exclude" position="0 7.5 -10" rotation="0 0 0" width="20" height="15"
            material="src: #wall-texture; repeat: 8 6; side: double">
        </a-plane>

        <a-plane class="room-element ar-exclude" position="-10 7.5 0" rotation="0 90 0" width="20" height="15"
            material="src: #wall-texture; repeat: 8 6; side: double">
        </a-plane>

        <a-plane class="room-element ar-exclude" position="10 7.5 0" rotation="0 -90 0" width="20" height="15"
            material="src: #wall-texture; repeat: 8 6; side: double">
        </a-plane>

        <a-plane class="room-element ar-exclude" position="0 0 0" rotation="-90 0 0" width="20" height="20"
            material="src: #floor-texture; repeat: 8 8">
        </a-plane>

        <a-plane class="room-element ar-exclude" position="0 15 0" rotation="90 0 0" width="20" height="20"
            color="#8B4513">
        </a-plane>

        <!-- Poker Table -->
        <a-entity class="ar-exclude" id="poker-table" gltf-model="#poker-table" position="0 0 -2" scale="2 2 2">
        </a-entity>

        <!-- Menu -->
        <!-- Menu -->
        <a-entity position="0 2.5 -6" rotation="0 180 0" menu-handler>
            <!-- Menü -->
            <a-gui-flex-container flex-direction="column" justify-content="center" align-items="center" opacity="0.5"
                width="3.5" height="4.5" panel-color="#1E1E1E" panel-rounded="0.2" position="0 0 0">

                <!-- Titel -->
                <a-gui-label width="3" height="0.5" value="Memory Game" font-size="0.3" font-color="#FFFFFF"
                    background-color="#333333" margin="0 0 0.2 0"></a-gui-label>
                <a-gui-label width="3" height="0.5" value="Spieler 1" font-size="0.3" font-color="#FFFFFF"
                    background-color="#333333" margin="0 0 0.2 0"></a-gui-label>

                <!-- Start Game Button -->
                <a-gui-button width="2.5" height="0.7" value="Start Game" font-size="0.4" font-color="#FFFFFF"
                    background-color="#4CAF50" hover-color="#45A049" active-color="#388E3C" onclick="startGame()"
                    margin="0 0 0.2 0"></a-gui-button>

                <a-gui-button width="2.5" height="0.7" value="Leaderboard" font-size="0.4" font-color="#FFFFFF"
                    background-color="#888CB7" hover-color="#6B6B6B" active-color="#545454" onclick="showLeaderboard()"
                    margin="0 0 0.2 0">
                </a-gui-button>

                <!-- Exit Button -->
                <a-gui-button width="2.5" height="0.7" value="Exit" font-size="0.4" font-color="#FFFFFF"
                    background-color="#F44336" hover-color="#D32F2F" active-color="#B71C1C" onclick="exitGame()"
                    margin="0 0 0.2 0"></a-gui-button>

            </a-gui-flex-container>


        </a-entity>

        <!-- Ingame-Menü -->
        <a-entity id="ingameMenu" position="0 4 0" rotation="0 180 0" visible="false">
            <a-gui-flex-container flex-direction="column" justify-content="center" align-items="flex-start" width="2.5"
                height="2.5" panel-color="#333333" opacity="0.8" panel-rounded="0.2">

                <a-gui-label id="timerLabel" width="2.3" height="0.4" value="Time: 00:00" font-size="0.3"
                    font-color="#FFFFFF" background-color="#444444"></a-gui-label>

                <a-gui-label id="pairsLabel" width="2.3" height="0.4" value="Pairs Found: 0" font-size="0.3"
                    font-color="#FFFFFF" background-color="#444444"></a-gui-label>

                <!-- Reset Button -->
                <a-gui-button width="2.3" height="0.5" value="Reset Game" font-size="0.3" font-color="#FFFFFF"
                    background-color="#FF9800" hover-color="#FB8C00" active-color="#EF6C00" onclick="resetGame()"
                    margin="0.1 0 0.1 0">
                </a-gui-button>

                <!-- Back to Menu Button -->
                <a-gui-button width="2.3" height="0.5" value="Back to Menu" font-size="0.3" font-color="#FFFFFF"
                    background-color="#F44336" hover-color="#E53935" active-color="#D32F2F" onclick="backToMenu()"
                    margin="0.1 0 0.1 0">
                </a-gui-button>
            </a-gui-flex-container>
        </a-entity>

        <a-entity id="victoryMessage" position="0 4 0" rotation="0 180 0" visible="false">
            <a-gui-flex-container flex-direction="column" justify-content="center" align-items="center" width="3.5"
                height="2.5" panel-color="#FFD700" opacity="0.9" panel-rounded="0.2">

                <a-gui-label width="3" height="0.5" value="Victory!" font-size="0.4" font-color="#000000"
                    background-color="#FFD700"></a-gui-label>

                <a-gui-label id="finalTimeLabel" width="3" height="0.4" value="Time: 00:00" font-size="0.3"
                    font-color="#000000" background-color="#FFFFFF"></a-gui-label>

                <a-gui-label id="finalPairsLabel" width="3" height="0.4" value="Pairs Found: 0" font-size="0.3"
                    font-color="#000000" background-color="#FFFFFF"></a-gui-label>
            </a-gui-flex-container>
        </a-entity>

        <!-- Leaderboard Menu -->
        <a-entity id="leaderboardMenu" position="0 2.5 -5" rotation="0 180 0" visible="false">
            <a-gui-flex-container id="leaderboardContainer" width="3" height="4" panel-color="#222" opacity="0.8"
                flex-direction="column" align-items="center" justify-content="flex-start">
                <a-gui-label value="Leaderboard" width="2.5" height="0.5" font-size="0.3" background-color="#444"
                    margin="0 0 0.2 0">
                </a-gui-label>

                <a-gui-button width="2" height="0.7" value="Back" font-size="0.3" font-color="#FFFFFF"
                    background-color="#666" hover-color="#444" active-color="#222" onclick="hideLeaderboard()"
                    margin="0 0 0.2 0">
                </a-gui-button>
                <!-- Dynamisch generierte Leaderboard-Einträge -->
                <!-- Diese werden über JavaScript hinzugefügt -->
                <a-gui-label id="leaderboardEntry1" value="1. ---" width="2.5" height="0.4" font-size="0.2"
                    font-color="#FFFFFF" background-color="#333" margin="0 0 0.1 0"></a-gui-label>
                <a-gui-label id="leaderboardEntry2" value="2. ---" width="2.5" height="0.4" font-size="0.2"
                    font-color="#FFFFFF" background-color="#333" margin="0 0 0.1 0"></a-gui-label>
                <a-gui-label id="leaderboardEntry3" value="3. ---" width="2.5" height="0.4" font-size="0.2"
                    font-color="#FFFFFF" background-color="#333" margin="0 0 0.1 0"></a-gui-label>
                <a-gui-label id="leaderboardEntry4" value="4. ---" width="2.5" height="0.4" font-size="0.2"
                    font-color="#FFFFFF" background-color="#333" margin="0 0 0.1 0"></a-gui-label>

                </a-gui-button>
            </a-gui-flex-container>
        </a-entity>

        <a-entity id="keyboard" a-keyboard>

        </a-entity>

        <!-- Memory Cards -->
        <a-entity position="-0.5 2.5 -2.7" game-manager>
        </a-entity>




        <!-- Lighting -->
        <!-- Ambient light for general room illumination -->
        <a-light type="ambient" intensity="0.4" color="#4C4C4C"></a-light>

        <!-- Point lights for walls -->
        <a-light type="point" position="-5 7.5 0" intensity="0.1" color="#FFF" decay="2"></a-light>
        <a-light type="point" position="5 7.5 0" intensity="0.1" color="#FFF" decay="2"></a-light>

        <!-- Softer spotlight for table -->
        <a-light type="spot" position="0 10 -2" rotation="-90 0 0" intensity="0.8" angle="60" penumbra="0.6"
            decay="1.5">
        </a-light>
        <a-sky color="#111111"></a-sky> </a-scene>



    <script>
        function exitGame() {
            // Timer stoppen
            clearInterval(timerInterval);

            // Ingame-Menü ausblenden
            const ingameMenu = document.querySelector('#ingameMenu');
            ingameMenu.setAttribute('visible', false);
            window.close();
        }
        window.playerName = "Player"; // Standardname

        window.gameTime = 0;
        window.pairsFound = 0;
        window.timerInterval = null;

        window.startGame = function () {
            console.log("startGame")
            // Get the camera rig
            const cameraRig = document.querySelector('#cameraRig');

            // New position closer to the table
            cameraRig.setAttribute('position', '0 1 -4');
            cameraRig.setAttribute('rotation', '0 180 0');

            const mainMenu = document.querySelector('[menu-handler]');
            mainMenu.setAttribute('visible', false);

            // Ingame-Menü sichtbar machen
            const ingameMenu = document.querySelector('#ingameMenu');
            ingameMenu.setAttribute('visible', true);

            // Timer zurücksetzen und starten
            gameTime = 0;
            pairsFound = 0;
            updatePairsFound();
            timerInterval = setInterval(updateTimer, 1000);

            // Get game manager and start the game
            const gameManager = document.querySelector('[game-manager]').components['game-manager'];
            gameManager.startNewGame();
        }

        // Timer aktualisieren
        function updateTimer() {
            gameTime++;
            const minutes = Math.floor(gameTime / 60);
            const seconds = gameTime % 60;
            const formattedTime = `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const timerLabel = document.querySelector('#timerLabel');
            timerLabel.setAttribute('value', formattedTime);
        }

        // Gefundene Paare aktualisieren
        window.updatePairsFound = function () {
            const pairsLabel = document.querySelector('#pairsLabel');
            pairsLabel.setAttribute('value', `Pairs Found: ${pairsFound}`);
        }

        function resetGame() {
            // Timer zurücksetzen
            gameTime = 0;
            pairsFound = 0;
            updatePairsFound();

            // Timer neu starten
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);

            // Update timer display immediately
            const timerLabel = document.querySelector('#timerLabel');
            timerLabel.setAttribute('value', 'Time: 00:00');

            // Spielmanager für Neustart des Spiels
            const gameManager = document.querySelector('[game-manager]').components['game-manager'];
            gameManager.startNewGame();
        }

        function backToMenu() {
            // Timer stoppen
            clearInterval(timerInterval);


            // Show main menu
            const mainMenu = document.querySelector('[menu-handler]');
            mainMenu.setAttribute('visible', true);
            mainMenu.setAttribute('pointer-events', 'auto'); // Aktiviert Interaktionen


            // Ingame-Menü ausblenden
            const ingameMenu = document.querySelector('#ingameMenu');
            ingameMenu.setAttribute('visible', false);

            // Kamera zurücksetzen
            const cameraRig = document.querySelector('#cameraRig');
            cameraRig.setAttribute('position', '0 2 -10');
            cameraRig.setAttribute('rotation', '0 180 0');

            // Clear cards instead of calling undefined endGame
            const gameManager = document.querySelector('[game-manager]');
            while (gameManager.firstChild) {
                gameManager.removeChild(gameManager.firstChild);
            }
        }

        const sceneEl = document.querySelector('a-scene');

        sceneEl.addEventListener('loaded', () => {
            // Event für den Wechsel in AR/VR-Modus
            sceneEl.addEventListener('enter-vr', () => {
                const isAR = sceneEl.renderer.xr.getSession().environmentBlendMode === 'additive' ||
                    sceneEl.renderer.xr.getSession().environmentBlendMode === 'alpha-blend';

                // Elemente mit der Klasse "ar-exclude" ein- oder ausblenden
                document.querySelectorAll('.ar-exclude').forEach(el => {
                    el.setAttribute('visible', !isAR); // Unsichtbar im AR-Modus
                });

                if (isAR) {
                    // Deaktiviere Skybox
                    const skyEl = document.querySelector('a-sky');
                    if (skyEl) {
                        skyEl.setAttribute('visible', false);
                    }

                    // Setze den Hintergrund des Renderers auf transparent
                    sceneEl.renderer.setClearColor(new THREE.Color(0x000000), 0); // Transparenter Hintergrund
                } else {
                    // Reaktiviere Skybox und Hintergrundfarbe für VR
                    const skyEl = document.querySelector('a-sky');
                    if (skyEl) {
                        skyEl.setAttribute('visible', true);
                    }

                    // Setze eine Hintergrundfarbe für VR
                    sceneEl.renderer.setClearColor(new THREE.Color(0x111111), 1); // Dunkler Hintergrund
                }
            });
        });

        window.checkVictory = function () {
            if (pairsFound === 8) { // Anzahl der Paare anpassen, falls nötig
                clearInterval(timerInterval); // Timer stoppen

                // Aktualisiere die Victory-Anzeige
                const victoryMessage = document.querySelector('#victoryMessage');
                const finalTimeLabel = document.querySelector('#finalTimeLabel');
                const finalPairsLabel = document.querySelector('#finalPairsLabel');

                const minutes = Math.floor(gameTime / 60);
                const seconds = gameTime % 60;
                const finalTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                finalTimeLabel.setAttribute('value', `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
                finalPairsLabel.setAttribute('value', `Pairs Found: ${pairsFound}`);

                // Victory-Meldung einblenden
                victoryMessage.setAttribute('visible', true);

                ingameMenu.setAttribute('visible', false);

                // Ergebnis speichern und Leaderboard aktualisieren
                saveLeaderboardEntry(window.playerName, finalTime);


                // Nach 3 Sekunden ins Hauptmenü zurückkehren
                setTimeout(() => {
                    victoryMessage.setAttribute('visible', false);
                    backToMenu();
                }, 7000);
            }
        };

        // Rufe `checkVictory()` jedes Mal auf, wenn ein Paar gefunden wurde
        window.updatePairsFound = function () {
            const pairsLabel = document.querySelector('#pairsLabel');
            pairsLabel.setAttribute('value', `Pairs Found: ${pairsFound}`);

            checkVictory(); // Überprüfen, ob der Spieler gewonnen hat
        };

        window.showLeaderboard = function () {
            // Hide main menu
            const mainMenu = document.querySelector('[menu-handler]');
            mainMenu.setAttribute('visible', false);
            mainMenu.setAttribute('pointer-events', 'none'); // Deaktiviert Interaktionen


            // Show leaderboard
            const leaderboardMenu = document.querySelector('#leaderboardMenu');
            leaderboardMenu.setAttribute('visible', true);
            leaderboardMenu.setAttribute('pointer-events', 'auto'); // Aktiviert Interaktionen

        };

        window.hideLeaderboard = function () {

            console.log("test")
            // Hide leaderboard
            const leaderboardMenu = document.querySelector('#leaderboardMenu');
            leaderboardMenu.setAttribute('visible', false);
            leaderboardMenu.setAttribute('pointer-events', 'none'); // Deaktiviert Interaktionen


            backToMenu();
        };

        function saveLeaderboardEntry(name, time) {
            // Leaderboard aus localStorage laden oder neues Array erstellen
            console.log("saveLeaderboardEntry called with:", name, time);
            if (typeof time !== 'string' || !/^\d{2}:\d{2}$/.test(time)) {
                console.error("Invalid time format:", time);
                return; // Beende die Funktion, wenn das Format ungültig ist
            }
            let leaderboard = JSON.parse(localStorage.getItem("leaderboard")) || [];
            console.log("Aktuelles Leaderboard vor dem Hinzufügen:", leaderboard); // Log hinzufügen

            // Neuen Eintrag hinzufügen
            leaderboard.push({ name: name, time: time });
            console.log("Neuer Eintrag hinzugefügt:", { name: name, time: time }); // Log hinzufügen

            // Leaderboard nach Zeit sortieren (MM:SS → Sekunden)


            // Optional: Begrenze das Leaderboard auf die Top 10
            leaderboard = leaderboard.slice(0, 4);

            // Leaderboard in localStorage speichern
            localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
            console.log("Leaderboard in localStorage gespeichert."); // Log hinzufügen

            // Leaderboard im UI aktualisieren
            updateLeaderboardUI();
        }
        function updateLeaderboardUI() {

            // Leaderboard aus localStorage laden
            let leaderboard = JSON.parse(localStorage.getItem("leaderboard")) || [];
            console.log("Leaderboard geladen aus localStorage:", leaderboard);

            // **Aktualisiere nur die Top 4 Einträge**
            for (let i = 0; i < 4; i++) { // Ändere die Schleife von 10 auf 4
                const entryLabel = document.querySelector(`#leaderboardEntry${i + 1}`);
                if (leaderboard[i]) {
                    entryLabel.setAttribute('value', `${i + 1}. ${leaderboard[i].name} (${leaderboard[i].time})`);
                } else {
                    entryLabel.setAttribute('value', `${i + 1}. ---`);
                }
            }

            console.log("Leaderboard UI aktualisiert mit den Top 4 Einträgen.");
        }
        // Funktion zum Verarbeiten der Namenseingabe
        function handleNameInput() {
            console.log("name")
            const name = event.target.getAttribute('value').trim();
            if (name !== "") {
                window.playerName = name;
                console.log("Player name set to:", window.playerName);
            }
        }

        document.querySelector('#nameInput').addEventListener('click', () => {
            document.querySelector('#virtualKeyboard').setAttribute('visible', true);
        });

        // Schließen der Tastatur nach Eingabe
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.querySelector('#virtualKeyboard').setAttribute('visible', false);
                handleNameInput();
            }
        });


    </script>


</body>

</html>